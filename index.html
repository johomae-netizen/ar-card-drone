<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AR Drone (Stable Spawn + Distance 2m)</title>

  <!-- A-Frame & AR.js -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/1.7.7/aframe/build/aframe-ar.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.9.0/nipplejs.min.js"></script>

  <style>
    body {
      margin: 0; overflow: hidden;
      user-select: none; -webkit-user-select: none;
      touch-action: none; -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
    }
    #leftStick, #rightStick {
      position: fixed; bottom: 20px; width: 150px; height: 150px; z-index: 10;
    }
    #leftStick { left: 20px; }
    #rightStick { right: 20px; }
    #hint {
      position: fixed; left: 8px; right: 8px; top: 8px; z-index: 9;
      background: rgba(0,0,0,.55); color: #fff; padding: 8px 10px; border-radius: 10px;
      font: 13px/1.4 -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
      text-align: center;
    }
  </style>
</head>

<body>
  <div id="hint">Â∑¶: ‰∏äÊòá/ÂõûËª¢„ÄÄÂè≥: ÂâçÂæå/Â∑¶Âè≥ÔΩú„Éû„Éº„Ç´„ÉºÂÜçÊ§úÂá∫„ÅßÂàùÊúüÂåñ</div>
  <div id="leftStick"></div>
  <div id="rightStick"></div>

  <a-scene embedded arjs="trackingMethod: best; debugUIEnabled: false;">
    <a-marker id="marker" preset="hiro"></a-marker>
    <a-entity id="worldRoot"></a-entity>
    <a-entity camera></a-entity>
  </a-scene>

  <script>
    const worldRoot = document.getElementById('worldRoot');
    const marker = document.getElementById('marker');
    let drone = null;

    const pos = new THREE.Vector3();
    const yawEuler = new THREE.Euler(0, THREE.MathUtils.degToRad(180), 0, 'XYZ');
    let currentTilt = { pitch: 0, roll: 0 };

    const SPEED_XZ   = 0.008;
    const SPEED_Y    = 0.015;
    const SPEED_YAW  = 1.2;
    const TILT_MAX   = 10;
    const TILT_SMOOTH= 0.12;

    let takeoff = { active: false, start: 0, dur: 1200, lift: 0.25 };
    let hover = { phase: 0, amp: 0.02, speed: 2.3 };
    const rotorConfig = { rpmIdle: 900, rpmMax: 2200, axis: new THREE.Vector3(0,1,0) };
    let rotors = [], currentRPM = 0;
    function rpmToRadPerSec(rpm){ return rpm * Math.PI * 2 / 60; }

    const manualRotorNames = [
      'mavic_air_dronemavic_air_drone_armsmavic_air_drone_arm_front_rgtmavic_air_drone_front_prop_rgt',
      'mavic_air_dronemavic_air_drone_armsmavic_air_drone_arm_front_lftmavic_air_drone_front_prop_lft',
      'mavic_air_dronemavic_air_drone_arm_rear_rgtmavic_air_drone_armsmavic_air_drone_rear_prop_rgt',
      'mavic_air_dronemavic_air_drone_armsmavic_air_drone_arm_rear_lftmavic_air_drone_rear_prop_lft'
    ];
    function collectRotors(root){
      rotors = [];
      manualRotorNames.forEach(name=>{
        const node = root.getObjectByName(name);
        if (node) rotors.push({ obj: node, axis: rotorConfig.axis.clone() });
      });
    }

    function spawnDroneAtMarkerInitial() {
      console.log("üì° markerFound ‚Üí drone spawnÈñãÂßã");

      if (drone && drone.parentNode) drone.parentNode.removeChild(drone);
      drone = document.createElement('a-entity');
      drone.setAttribute('gltf-model', 'https://johomae-netizen.github.io/ar-card-drone/drone.glb');
      drone.setAttribute('scale', '0.6 0.6 0.6');

      drone.addEventListener('model-loaded', () => {
        console.log("‚úÖ drone.glb Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü");
        const root = drone.getObject3D('mesh') || drone.object3D;
        if (root) collectRotors(root);
      });

      worldRoot.appendChild(drone);

      const mPos = new THREE.Vector3(), mQuat = new THREE.Quaternion(), mScale = new THREE.Vector3();
      marker.object3D.matrixWorld.decompose(mPos, mQuat, mScale);

      // üìè „Åï„Çâ„Å´ÈÅ†„Åè„ÉªÈ´ò„Åè„Å´ÈÖçÁΩÆ
      const offsetLocal = new THREE.Vector3(0, -0.2, 0.1);
      offsetLocal.applyQuaternion(mQuat);
      pos.copy(mPos).add(offsetLocal);

      yawEuler.set(0, THREE.MathUtils.degToRad(180), 0);
      drone.object3D.position.copy(pos);
      drone.object3D.rotation.set(0, yawEuler.y, 0);

      takeoff.active = true;
      takeoff.start = performance.now();
      currentRPM = rotorConfig.rpmIdle * 0.2;
    }

    marker.addEventListener('markerFound', spawnDroneAtMarkerInitial);

    // „Ç∏„Éß„Ç§„Çπ„ÉÜ„Ç£„ÉÉ„ÇØ
    const input = { left: {x:0,y:0}, right:{x:0,y:0} };
    const left = nipplejs.create({ zone: document.getElementById('leftStick'), mode:'static', position:{left:'75px',bottom:'75px'}, color:'white' });
    const right= nipplejs.create({ zone: document.getElementById('rightStick'), mode:'static', position:{right:'75px',bottom:'75px'}, color:'white' });
    left.on('move',(_,data)=>{ input.left.x=data.vector.x; input.left.y=data.vector.y; });
    left.on('end',()=>{ input.left.x=0; input.left.y=0; });
    right.on('move',(_,data)=>{ input.right.x=data.vector.x; input.right.y=data.vector.y; });
    right.on('end',()=>{ input.right.x=0; input.right.y=0; });

    function tick(){
      if(drone){
        const now=performance.now();
        let dt=0.016;
        let offsetY=0;

        if(takeoff.active){
          const t=Math.min(1,(now-takeoff.start)/takeoff.dur);
          offsetY=takeoff.lift*t;
          if(t>=1) takeoff.active=false;
        }else{
          hover.phase+=hover.speed*dt;
          offsetY=Math.sin(hover.phase)*hover.amp;
        }

        pos.y += input.left.y * SPEED_Y;
        yawEuler.y += THREE.MathUtils.degToRad(-input.left.x * SPEED_YAW);
        pos.x += input.right.x * SPEED_XZ;
        pos.z += -input.right.y * SPEED_XZ;

        const targetPitch = THREE.MathUtils.degToRad( TILT_MAX * input.right.y);
        const targetRoll  = THREE.MathUtils.degToRad(-TILT_MAX * input.right.x);
        currentTilt.pitch = THREE.MathUtils.lerp(currentTilt.pitch, targetPitch, TILT_SMOOTH);
        currentTilt.roll  = THREE.MathUtils.lerp(currentTilt.roll, targetRoll,  TILT_SMOOTH);

        drone.object3D.position.set(pos.x, pos.y + offsetY, pos.z);
        drone.object3D.rotation.set(currentTilt.pitch, yawEuler.y, currentTilt.roll);
      }
      requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  </script>
</body>
</html>
