<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AR Drone Business Card</title>

  <!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/1.7.7/aframe/build/aframe-ar.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.9.0/nipplejs.min.js"></script>

  <style>
    /* ========== åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« ========== */
    body { 
      margin: 0; 
      overflow: hidden; 
      background: #000; 
      touch-action: none; 
      user-select: none; 
      -webkit-user-select: none; 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    /* ========== ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã‚¨ãƒªã‚¢ ========== */
    #leftStick, #rightStick {
      position: fixed; 
      bottom: 20px; 
      width: 150px; 
      height: 150px; 
      z-index: 10;
      touch-action: none; 
      -webkit-user-select: none;
    }
    #leftStick { left: 20px; }
    #rightStick { right: 20px; }
    
    /* ========== æ“ä½œã‚¬ã‚¤ãƒ‰ ========== */
    #hint {
      position: fixed; 
      left: 8px; 
      right: 8px; 
      top: 8px; 
      z-index: 9;
      background: rgba(0, 0, 0, 0.7); 
      color: #fff; 
      padding: 10px 12px; 
      border-radius: 12px;
      font-size: 13px; 
      line-height: 1.5; 
      text-align: center;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    /* ========== ã‚«ãƒ¡ãƒ©è¨±å¯æ¡ˆå†… ========== */
    #camera-hint {
      position: fixed; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.85); 
      color: #fff; 
      padding: 24px 28px;
      border-radius: 16px; 
      font-size: 15px; 
      line-height: 1.7;
      text-align: center; 
      z-index: 9999;
      animation: fadeOut 12s ease-in-out forwards;
      max-width: 90%;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    }
    
    /* ========== ã‚¢ãƒ—ãƒªå†…ãƒ–ãƒ©ã‚¦ã‚¶è­¦å‘Š ========== */
    #browser-warning {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 59, 48, 0.95);
      color: #fff;
      padding: 20px 24px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.6;
      text-align: center;
      z-index: 10000;
      max-width: 85%;
      display: none;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
    }
    
    #browser-warning button {
      margin-top: 12px;
      padding: 10px 20px;
      background: #fff;
      color: #FF3B30;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    
    /* ========== ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ ========== */
    @keyframes fadeOut {
      0% { opacity: 1; }
      75% { opacity: 1; }
      100% { opacity: 0; pointer-events: none; }
    }
  </style>
</head>

<body>
  <!-- UIè¦ç´  -->
  <div id="hint">
    å·¦ã‚¹ãƒ†ã‚£ãƒƒã‚¯ï¼ä¸Šæ˜‡/ä¸‹é™ + å›è»¢<br>
    å³ã‚¹ãƒ†ã‚£ãƒƒã‚¯ï¼å‰å¾Œå·¦å³ç§»å‹•<br>
    ğŸ“ ãƒãƒ¼ã‚«ãƒ¼ã‚’å†™ã™ã¨ä¸­å¤®ã«ãƒ‰ãƒ­ãƒ¼ãƒ³å‡ºç¾ğŸš
  </div>

  <div id="camera-hint">
    ğŸ“¸ <b>ã‚«ãƒ¡ãƒ©ã‚’è¨±å¯ã—ã¦ãã ã•ã„</b><br><br>
    "This site wants to access your camera" ã¨è¡¨ç¤ºã•ã‚ŒãŸã‚‰<br>
    <b style="color:#4A90E2;">é’ã„ãƒœã‚¿ãƒ³ ã¾ãŸã¯ã€ŒAllowï¼ˆè¨±å¯ï¼‰ã€</b>ã‚’é¸æŠ
  </div>
  
  <div id="browser-warning">
    âš ï¸ <b>ãƒ–ãƒ©ã‚¦ã‚¶ã®å¤‰æ›´ã‚’ãŠã™ã™ã‚ã—ã¾ã™</b><br><br>
    LINEã‚„Instagramã®ã‚¢ãƒ—ãƒªå†…ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯<br>æ­£å¸¸ã«å‹•ä½œã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚<br><br>
    <b>Safari</b>ï¼ˆiPhoneï¼‰ã¾ãŸã¯<b>Chrome</b>ï¼ˆAndroidï¼‰ã§é–‹ã„ã¦ãã ã•ã„ã€‚
    <button onclick="this.parentElement.style.display='none'">é–‰ã˜ã‚‹</button>
  </div>

  <!-- ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã‚¨ãƒªã‚¢ -->
  <div id="leftStick"></div>
  <div id="rightStick"></div>

  <!-- AR.js ã‚·ãƒ¼ãƒ³ -->
  <a-scene embedded arjs="trackingMethod: best; debugUIEnabled: false;">
    <a-marker preset="hiro" id="marker"></a-marker>
    <a-entity id="worldRoot"></a-entity>
    <a-entity id="cam" camera></a-entity>
  </a-scene>

  <script>
    // ========================================
    // AR Drone Business Card - ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
    // ========================================

    // ========== ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ==========
    const marker = document.getElementById('marker');
    const worldRoot = document.getElementById('worldRoot');
    const camEl = document.getElementById('cam');
    
    let drone = null;
    let rotors = [];
    
    const pos = new THREE.Vector3(0, 0, 0);
    const yawEuler = new THREE.Euler(0, THREE.MathUtils.degToRad(180), 0, 'XYZ');
    let currentTilt = { pitch: 0, roll: 0 };
    
    // ========== è¨­å®šå€¤ ==========
    const CONFIG = {
      // ç§»å‹•é€Ÿåº¦
      speedForward: 0.02,
      speedStrafe: 0.008,
      speedVertical: 0.015,
      speedYaw: 1.2,
      
      // ãƒãƒ«ãƒˆï¼ˆå‚¾ãï¼‰
      tiltMax: 10,
      tiltSmooth: 0.12,
      
      // ãƒ—ãƒ­ãƒšãƒ©å›è»¢ï¼ˆRPMåˆ¶å¾¡ï¼‰
      rpmIdle: 900,        // ã‚¢ã‚¤ãƒ‰ãƒ«çŠ¶æ…‹
      rpmHover: 1500,      // ãƒ›ãƒãƒªãƒ³ã‚°
      rpmMax: 2200,        // æœ€å¤§å‡ºåŠ›
      rpmAccel: 0.08,      // åŠ é€Ÿåº¦
      
      // é›¢é™¸ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      takeoffDuration: 1500,
      takeoffHeight: 0.25,
      
      // å¢ƒç•Œåˆ¶é™
      boundaryX: 1.5,
      boundaryY: { min: -0.3, max: 1.2 },
      boundaryZ: 1.5,
      
      // ã‚¹ãƒãƒ¼ãƒ³ä½ç½®
      spawnDistance: 0.6,
      spawnLift: 0.08
    };
    
    const rotorConfig = {
      axis: new THREE.Vector3(0, 1, 0)
    };
    
    let currentRPM = 0;
    const takeoffAnim = { 
      active: false, 
      start: 0 
    };
    
    // ========== ãƒ—ãƒ­ãƒšãƒ©ãƒãƒ¼ãƒ‰åãƒªã‚¹ãƒˆ ==========
    const rotorNames = [
      'mavic_air_dronemavic_air_drone_armsmavic_air_drone_arm_front_rgtmavic_air_drone_front_prop_rgt',
      'mavic_air_dronemavic_air_drone_armsmavic_air_drone_arm_front_lftmavic_air_drone_front_prop_lft',
      'mavic_air_dronemavic_air_drone_arm_rear_rgtmavic_air_drone_armsmavic_air_drone_rear_prop_rgt',
      'mavic_air_dronemavic_air_drone_armsmavic_air_drone_arm_rear_lftmavic_air_drone_rear_prop_lft'
    ];
    
    // ========== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ==========
    function rpmToRadPerSec(rpm) {
      return rpm * Math.PI * 2 / 60;
    }
    
    function collectRotors(root) {
      rotors = [];
      rotorNames.forEach(name => {
        const node = root.getObjectByName(name);
        if (node) {
          rotors.push({
            obj: node,
            axis: rotorConfig.axis.clone()
          });
        }
      });
      console.log(`âœ… ãƒ—ãƒ­ãƒšãƒ©æ¤œå‡º: ${rotors.length}å€‹`);
    }
    
    // ========== ãƒ‰ãƒ­ãƒ¼ãƒ³ç”Ÿæˆ ==========
    function spawnDrone() {
      // æ—¢å­˜ã®ãƒ‰ãƒ­ãƒ¼ãƒ³ãŒã‚ã‚Œã°å‰Šé™¤ã—ã¦æ–°ã—ãç”Ÿæˆ
      if (drone && drone.parentNode) {
        worldRoot.removeChild(drone);
        console.log('ğŸ”„ æ—¢å­˜ãƒ‰ãƒ­ãƒ¼ãƒ³ã‚’å‰Šé™¤ã—ã¦å†ç”Ÿæˆ');
      }
      
      drone = document.createElement('a-entity');
      drone.setAttribute('gltf-model', 'drone.glb');
      drone.setAttribute('scale', '2 2 2');
      worldRoot.appendChild(drone);
      
      drone.addEventListener('model-loaded', () => {
        const root = drone.getObject3D('mesh') || drone.object3D;
        if (root) collectRotors(root);
      });
      
      // ã‚«ãƒ¡ãƒ©ä½ç½®ã‹ã‚‰å‰æ–¹ã«ã‚¹ãƒãƒ¼ãƒ³
      const camObj = camEl.object3D;
      const camPos = new THREE.Vector3();
      const forward = new THREE.Vector3();
      camObj.getWorldPosition(camPos);
      camObj.getWorldDirection(forward);
      
      pos.copy(camPos)
        .add(forward.multiplyScalar(CONFIG.spawnDistance))
        .add(new THREE.Vector3(0, CONFIG.spawnLift, 0));
      
      // ã‚«ãƒ¡ãƒ©ã®å‘ãã«åˆã‚ã›ã‚‹
      const camQuat = camObj.getWorldQuaternion(new THREE.Quaternion());
      const camEuler = new THREE.Euler().setFromQuaternion(camQuat, 'YXZ');
      yawEuler.set(0, camEuler.y + Math.PI, 0);
      
      currentTilt = { pitch: 0, roll: 0 };
      drone.object3D.position.copy(pos);
      drone.object3D.rotation.set(currentTilt.pitch, yawEuler.y, currentTilt.roll);
      
      // é›¢é™¸ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
      takeoffAnim.active = true;
      takeoffAnim.start = performance.now();
      currentRPM = CONFIG.rpmIdle * 0.2;
      
      console.log('ğŸš ãƒ‰ãƒ­ãƒ¼ãƒ³ç”Ÿæˆå®Œäº†ï¼ˆãƒãƒ¼ã‚«ãƒ¼å†æ¤œå‡ºã§ç”»é¢ä¸­å¤®ã«å†é…ç½®ï¼‰');
    }
    
    // ========== ãƒãƒ¼ã‚«ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ ==========
    marker.addEventListener('markerFound', () => {
      console.log('ğŸ“ ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡º');
      spawnDrone();
    });
    
    // ========== ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯è¨­å®š ==========
    const input = {
      left: { x: 0, y: 0 },
      right: { x: 0, y: 0 }
    };
    
    // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã®ä¼æ’­ã‚’é˜²æ­¢
    const stopTouch = (e) => {
      e.preventDefault();
      e.stopPropagation();
      return false;
    };
    
    document.addEventListener('touchstart', stopTouch, { passive: false });
    document.addEventListener('touchmove', stopTouch, { passive: false });
    
    // å·¦ã‚¹ãƒ†ã‚£ãƒƒã‚¯ï¼ˆä¸Šæ˜‡/ä¸‹é™ + æ—‹å›ï¼‰
    const left = nipplejs.create({
      zone: document.getElementById('leftStick'),
      mode: 'static',
      position: { left: '75px', bottom: '75px' },
      color: 'white'
    });
    
    left.on('move', (_, data) => {
      input.left.x = data.vector.x;
      input.left.y = data.vector.y;
    });
    
    left.on('end', () => {
      input.left.x = 0;
      input.left.y = 0;
    });
    
    // å³ã‚¹ãƒ†ã‚£ãƒƒã‚¯ï¼ˆå‰å¾Œå·¦å³ç§»å‹•ï¼‰
    const right = nipplejs.create({
      zone: document.getElementById('rightStick'),
      mode: 'static',
      position: { right: '75px', bottom: '75px' },
      color: 'white'
    });
    
    right.on('move', (_, data) => {
      input.right.x = data.vector.x;
      input.right.y = data.vector.y;
    });
    
    right.on('end', () => {
      input.right.x = 0;
      input.right.y = 0;
    });
    
    // ========== ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ— ==========
    function tick() {
      requestAnimationFrame(tick);
      
      if (!drone) return;
      
      // é›¢é™¸ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†
      let takeoffOffset = 0;
      if (takeoffAnim.active) {
        const elapsed = performance.now() - takeoffAnim.start;
        const t = Math.min(1, elapsed / CONFIG.takeoffDuration);
        takeoffOffset = CONFIG.takeoffHeight * (1 - Math.pow(1 - t, 3));
        
        if (t >= 1) {
          takeoffAnim.active = false;
        }
        
        currentRPM += (CONFIG.rpmIdle - currentRPM) * 0.05;
      } else {
        // æ“ä½œã«å¿œã˜ãŸRPMåˆ¶å¾¡
        const inputMagnitude = Math.sqrt(
          input.left.y ** 2 + 
          input.right.x ** 2 + 
          input.right.y ** 2
        );
        
        const targetRPM = inputMagnitude > 0.1 
          ? CONFIG.rpmHover + (CONFIG.rpmMax - CONFIG.rpmHover) * Math.min(inputMagnitude, 1)
          : CONFIG.rpmHover;
        
        currentRPM += (targetRPM - currentRPM) * CONFIG.rpmAccel;
      }
      
      // ä½ç½®æ›´æ–°
      pos.y += input.left.y * CONFIG.speedVertical;
      yawEuler.y += THREE.MathUtils.degToRad(-input.left.x * CONFIG.speedYaw);
      
      // ãƒ¨ãƒ¼è§’ã«åŸºã¥ã„ãŸå‰å¾Œå·¦å³ç§»å‹•
      const yawCos = Math.cos(yawEuler.y);
      const yawSin = Math.sin(yawEuler.y);
      
      const fwd = input.right.y * CONFIG.speedForward;
      const strafe = input.right.x * CONFIG.speedStrafe;
      
      pos.x += fwd * yawSin + strafe * yawCos;
      pos.z += fwd * yawCos - strafe * yawSin;
      
      // å¢ƒç•Œåˆ¶é™
      pos.x = THREE.MathUtils.clamp(pos.x, -CONFIG.boundaryX, CONFIG.boundaryX);
      pos.y = THREE.MathUtils.clamp(pos.y, CONFIG.boundaryY.min, CONFIG.boundaryY.max);
      pos.z = THREE.MathUtils.clamp(pos.z, -CONFIG.boundaryZ, CONFIG.boundaryZ);
      
      // ãƒãƒ«ãƒˆæ›´æ–°
      const targetPitch = THREE.MathUtils.degToRad(CONFIG.tiltMax * input.right.y);
      const targetRoll = THREE.MathUtils.degToRad(-CONFIG.tiltMax * input.right.x);
      
      currentTilt.pitch = THREE.MathUtils.lerp(currentTilt.pitch, targetPitch, CONFIG.tiltSmooth);
      currentTilt.roll = THREE.MathUtils.lerp(currentTilt.roll, targetRoll, CONFIG.tiltSmooth);
      
      // ãƒ‰ãƒ­ãƒ¼ãƒ³ä½ç½®ãƒ»å§¿å‹¢æ›´æ–°
      drone.object3D.position.set(pos.x, pos.y + takeoffOffset, pos.z);
      drone.object3D.rotation.set(currentTilt.pitch, yawEuler.y, currentTilt.roll);
      
      // ãƒ—ãƒ­ãƒšãƒ©å›è»¢
      if (rotors.length > 0) {
        const dAngle = rpmToRadPerSec(currentRPM) * 0.016;
        for (const rotor of rotors) {
          rotor.obj.rotateOnAxis(rotor.axis, dAngle);
        }
      }
    }
    
    requestAnimationFrame(tick);
    
    // ========== ã‚¢ãƒ—ãƒªå†…ãƒ–ãƒ©ã‚¦ã‚¶æ¤œå‡º ==========
    function detectInAppBrowser() {
      const ua = navigator.userAgent.toLowerCase();
      const isLine = ua.includes('line');
      const isInstagram = ua.includes('instagram');
      const isFacebook = ua.includes('fb') || ua.includes('facebook');
      const isTwitter = ua.includes('twitter');
      const isWeChat = ua.includes('micromessenger');
      
      if (isLine || isInstagram || isFacebook || isTwitter || isWeChat) {
        document.getElementById('browser-warning').style.display = 'block';
        console.warn('âš ï¸ ã‚¢ãƒ—ãƒªå†…ãƒ–ãƒ©ã‚¦ã‚¶ã‚’æ¤œå‡º');
        return true;
      }
      return false;
    }
    
    window.addEventListener('load', () => {
      detectInAppBrowser();
    });
    
    // ========== èµ·å‹•ãƒ­ã‚° ==========
    console.log('ğŸš AR Drone Business Card ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•');
    console.log('ğŸ“‹ å®Ÿè£…æ©Ÿèƒ½:');
    console.log('  âœ… ãƒãƒ¼ã‚«ãƒ¼å†æ¤œå‡ºæ™‚ã¯ç”»é¢ä¸­å¤®ã«å†é…ç½®');
    console.log('  âœ… ãƒãƒ¼ã‚«ãƒ¼ã‚’å¤–ã—ã¦ã‚‚é£›è¡Œç¶™ç¶š');
    console.log('  âœ… æ“ä½œã«å¿œã˜ãŸRPMåˆ¶å¾¡ï¼ˆã‚¢ã‚¤ãƒ‰ãƒ«â†’ãƒ›ãƒãƒ¼â†’æœ€å¤§ï¼‰');
    console.log('  âœ… å¢ƒç•Œåˆ¶é™ï¼ˆX:Â±1.5m, Y:-0.3ã€œ1.2m, Z:Â±1.5mï¼‰');
    console.log('  âœ… ã‚¢ãƒ—ãƒªå†…ãƒ–ãƒ©ã‚¦ã‚¶æ¤œå‡ºï¼ˆLINE/Instagram/Facebook/Twitter/WeChatï¼‰');
  </script>
</body>
</html>
