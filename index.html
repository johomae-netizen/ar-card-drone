<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AR Drone - Ring Challenge</title>

  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/1.7.7/aframe/build/aframe-ar.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.9.0/nipplejs.min.js"></script>

  <style>
    body { 
      margin: 0; 
      overflow: hidden; 
      background: #000; 
      touch-action: none; 
      user-select: none; 
      -webkit-user-select: none; 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    #leftStick, #rightStick {
      position: fixed; 
      bottom: 20px; 
      width: 150px; 
      height: 150px; 
      z-index: 10;
      touch-action: none; 
      -webkit-user-select: none;
    }
    #leftStick { left: 20px; }
    #rightStick { right: 20px; }
    
    #hint {
      position: fixed; 
      left: 8px; 
      right: 8px; 
      top: 8px; 
      z-index: 9;
      background: rgba(0, 0, 0, 0.7); 
      color: #fff; 
      padding: 10px 12px; 
      border-radius: 12px;
      font-size: 13px; 
      line-height: 1.5; 
      text-align: center;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    #camera-hint {
      position: fixed; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.85); 
      color: #fff; 
      padding: 24px 28px;
      border-radius: 16px; 
      font-size: 15px; 
      line-height: 1.7;
      text-align: center; 
      z-index: 9999;
      animation: fadeOut 8s ease-in-out forwards;
      max-width: 90%;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      pointer-events: none;
    }
    
    #browser-warning {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 59, 48, 0.95);
      color: #fff;
      padding: 20px 24px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.6;
      text-align: center;
      z-index: 10000;
      max-width: 85%;
      display: none;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
    }
    
    #browser-warning button {
      margin-top: 12px;
      padding: 10px 20px;
      background: #fff;
      color: #FF3B30;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }

    /* ========== ã‚²ãƒ¼ãƒ UI ========== */
    #game-ui {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 8;
      text-align: center;
      pointer-events: none;
    }

    #score-display {
      background: rgba(0, 0, 0, 0.8);
      color: #FFD700;
      padding: 12px 24px;
      border-radius: 16px;
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 8px;
      text-shadow: 0 2px 8px rgba(255, 215, 0, 0.5);
    }

    #timer-display {
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 8px 20px;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    #rings-left {
      background: rgba(0, 120, 255, 0.8);
      color: #fff;
      padding: 8px 20px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
    }

    #combo-display {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 48px;
      font-weight: bold;
      color: #FFD700;
      text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
      opacity: 0;
      z-index: 999;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    #complete-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 200, 0, 0.95);
      color: #fff;
      padding: 30px 40px;
      border-radius: 20px;
      font-size: 36px;
      font-weight: bold;
      text-align: center;
      z-index: 1000;
      display: none;
      box-shadow: 0 8px 32px rgba(0, 200, 0, 0.5);
    }

    #game-controls {
      position: fixed;
      bottom: 200px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 8;
      display: flex;
      gap: 12px;
    }

    .game-btn {
      background: rgba(0, 120, 255, 0.9);
      color: #fff;
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 120, 255, 0.3);
      transition: all 0.3s;
    }

    .game-btn:active {
      transform: scale(0.95);
      box-shadow: 0 2px 8px rgba(0, 120, 255, 0.5);
    }

    .game-btn.reset {
      background: rgba(255, 59, 48, 0.9);
      box-shadow: 0 4px 12px rgba(255, 59, 48, 0.3);
    }

    .game-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    @keyframes fadeOut {
      0% { opacity: 1; }
      60% { opacity: 1; }
      100% { opacity: 0; pointer-events: none; }
    }

    @keyframes pulse {
      0%, 100% { transform: translate(-50%, -50%) scale(1); }
      50% { transform: translate(-50%, -50%) scale(1.1); }
    }
  </style>
</head>

<body>
  <div id="hint">
    å·¦ã‚¹ãƒ†ã‚£ãƒƒã‚¯ï¼ä¸Šæ˜‡/ä¸‹é™ + å›è»¢<br>
    å³ã‚¹ãƒ†ã‚£ãƒƒã‚¯ï¼å‰å¾Œå·¦å³ç§»å‹•<br>
    ğŸ¯ ãƒªãƒ³ã‚°ã‚’ããã£ã¦ã‚¹ã‚³ã‚¢ã‚’ç¨¼ã”ã†ï¼
  </div>

  <div id="camera-hint">
    ğŸ“¸ <b>ã‚«ãƒ¡ãƒ©è¨±å¯ãŒå¿…è¦ã§ã™</b><br><br>
    ãƒ–ãƒ©ã‚¦ã‚¶ã«è¡¨ç¤ºã•ã‚Œã‚‹<br>
    <b style="color:#4A90E2;">ã€Œè¨±å¯ã€ã¾ãŸã¯ã€ŒAllowã€</b>ã‚’é¸æŠã—ã¦ãã ã•ã„<br><br>
    <span style="font-size:12px; opacity:0.8;">â€»ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯è‡ªå‹•ã§æ¶ˆãˆã¾ã™</span>
  </div>
  
  <div id="browser-warning">
    âš ï¸ <b>ãƒ–ãƒ©ã‚¦ã‚¶ã®å¤‰æ›´ã‚’ãŠã™ã™ã‚ã—ã¾ã™</b><br><br>
    LINEã‚„Instagramã®ã‚¢ãƒ—ãƒªå†…ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯<br>æ­£å¸¸ã«å‹•ä½œã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚<br><br>
    <b>Safari</b>ï¼ˆiPhoneï¼‰ã¾ãŸã¯<b>Chrome</b>ï¼ˆAndroidï¼‰ã§é–‹ã„ã¦ãã ã•ã„ã€‚
    <button onclick="this.parentElement.style.display='none'">é–‰ã˜ã‚‹</button>
  </div>

  <!-- ã‚²ãƒ¼ãƒ UI -->
  <div id="game-ui">
    <div id="score-display">0</div>
    <div id="timer-display">30.0s</div>
    <div id="rings-left">æ®‹ã‚Š: 6å€‹</div>
  </div>

  <div id="combo-display"></div>

  <div id="complete-message">
    ğŸ‰ COMPLETE! ğŸ‰<br>
    <span style="font-size: 24px;" id="final-time"></span>
  </div>

  <div id="game-controls">
    <button class="game-btn" id="start-btn">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
    <button class="game-btn reset" id="reset-btn">ãƒªã‚»ãƒƒãƒˆ</button>
  </div>

  <div id="leftStick"></div>
  <div id="rightStick"></div>

  <a-scene embedded arjs="trackingMethod: best; debugUIEnabled: false;">
    <a-marker preset="hiro" id="marker"></a-marker>
    <a-entity id="worldRoot"></a-entity>
    <a-entity id="cam" camera></a-entity>
  </a-scene>

  <script>
    // A-Frameã®èª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã¤
    document.addEventListener('DOMContentLoaded', function() {
      initAR();
    });
    
    function initAR() {
    // ========== ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ==========
    const marker = document.getElementById('marker');
    const worldRoot = document.getElementById('worldRoot');
    const camEl = document.getElementById('cam');
    
    let drone = null;
    let rotors = [];
    let rings = [];
    
    const pos = new THREE.Vector3(0, 0, 0);
    const yawEuler = new THREE.Euler(0, THREE.MathUtils.degToRad(180), 0, 'XYZ');
    let currentTilt = { pitch: 0, roll: 0 };
    
    // ========== ã‚²ãƒ¼ãƒ çŠ¶æ…‹ ==========
    const gameState = {
      active: false,
      score: 0,
      startTime: 0,
      elapsedTime: 0,
      ringsCleared: 0,
      totalRings: 6,             // 8 â†’ 6å€‹ã«å‰Šæ¸›
      bestTime: localStorage.getItem('bestTime') || null,
      combo: 0,
      lastClearTime: 0,
      timeLimit: 30,             // 30ç§’åˆ¶é™
      gameOver: false
    };
    
    // ========== è¨­å®šå€¤ ==========
    const CONFIG = {
      speedForward: 0.025,      // 0.02 â†’ 0.025ï¼ˆ1.25å€é€Ÿï¼‰
      speedStrafe: 0.01,         // 0.008 â†’ 0.01ï¼ˆ1.25å€é€Ÿï¼‰
      speedVertical: 0.018,      // 0.015 â†’ 0.018ï¼ˆ1.2å€é€Ÿï¼‰
      speedYaw: 1.5,             // 1.2 â†’ 1.5ï¼ˆå›è»¢é€Ÿåº¦UPï¼‰
      tiltMax: 10,
      tiltSmooth: 0.12,
      rpmIdle: 900,
      rpmHover: 1500,
      rpmMax: 2200,
      rpmAccel: 0.08,
      takeoffDuration: 1500,
      takeoffHeight: 0.25,
      boundaryX: 1.8,            // 1.5 â†’ 1.8ï¼ˆç¯„å›²æ‹¡å¤§ï¼‰
      boundaryY: { min: -0.3, max: 1.4 },  // 1.2 â†’ 1.4ï¼ˆé«˜ã•æ‹¡å¤§ï¼‰
      boundaryZ: 1.8,            // 1.5 â†’ 1.8ï¼ˆå¥¥è¡Œãæ‹¡å¤§ï¼‰
      spawnDistance: 0.6,
      spawnLift: 0.08,
      ringRadius: 0.18,          // 0.15 â†’ 0.18ï¼ˆå°‘ã—å¤§ããï¼‰
      ringCheckDistance: 0.22,   // 0.2 â†’ 0.22ï¼ˆåˆ¤å®šã‚‚åºƒãï¼‰
      comboTimeWindow: 3000,
      timeLimit: 30              // åˆ¶é™æ™‚é–“30ç§’
    };
    
    const rotorConfig = {
      axis: new THREE.Vector3(0, 1, 0)
    };
    
    let currentRPM = 0;
    const takeoffAnim = { active: false, start: 0 };
    
    const rotorNames = [
      'mavic_air_dronemavic_air_drone_armsmavic_air_drone_arm_front_rgtmavic_air_drone_front_prop_rgt',
      'mavic_air_dronemavic_air_drone_armsmavic_air_drone_arm_front_lftmavic_air_drone_front_prop_lft',
      'mavic_air_dronemavic_air_drone_arm_rear_rgtmavic_air_drone_armsmavic_air_drone_rear_prop_rgt',
      'mavic_air_dronemavic_air_drone_armsmavic_air_drone_arm_rear_lftmavic_air_drone_rear_prop_lft'
    ];
    
    function rpmToRadPerSec(rpm) {
      return rpm * Math.PI * 2 / 60;
    }
    
    function collectRotors(root) {
      rotors = [];
      rotorNames.forEach(name => {
        const node = root.getObjectByName(name);
        if (node) {
          rotors.push({ obj: node, axis: rotorConfig.axis.clone() });
        }
      });
      console.log(`âœ… ãƒ—ãƒ­ãƒšãƒ©æ¤œå‡º: ${rotors.length}å€‹`);
    }
    
    // ========== ãƒªãƒ³ã‚°ç”Ÿæˆ ==========
    function createRing(position, isBonus = false) {
      const ring = document.createElement('a-torus');
      ring.setAttribute('radius', CONFIG.ringRadius);
      ring.setAttribute('radius-tubular', '0.02');
      ring.setAttribute('color', isBonus ? '#FFD700' : '#00BFFF');
      ring.setAttribute('metalness', '0.8');
      ring.setAttribute('roughness', '0.2');
      ring.setAttribute('position', `${position.x} ${position.y} ${position.z}`);
      ring.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 3000; easing: linear');
      
      worldRoot.appendChild(ring);
      
      return {
        element: ring,
        position: position.clone(),
        cleared: false,
        isBonus: isBonus
      };
    }
    
    function spawnRings() {
      clearRings();
      rings = [];
      
      // ãƒ©ãƒ³ãƒ€ãƒ ä½ç½®ç”Ÿæˆï¼ˆ30ç§’ç”¨ã«èª¿æ•´ï¼‰
      const positions = [];
      const minDistance = 0.35; // 0.3 â†’ 0.35ï¼ˆå°‘ã—é›¢ã™ï¼‰
      
      for (let i = 0; i < gameState.totalRings; i++) {
        let validPosition = false;
        let attempts = 0;
        let newPos;
        
        // ä»–ã®ãƒªãƒ³ã‚°ã¨è¢«ã‚‰ãªã„ä½ç½®ã‚’æ¢ã™ï¼ˆæœ€å¤§50å›è©¦è¡Œï¼‰
        while (!validPosition && attempts < 50) {
          newPos = new THREE.Vector3(
            (Math.random() - 0.5) * 3.0,  // 2.4 â†’ 3.0ï¼ˆç¯„å›²æ‹¡å¤§ï¼‰
            Math.random() * 1.0 + 0.25,   // 0.2~1.0 â†’ 0.25~1.25
            Math.random() * 0.8 + 0.3     // 0.3~0.9 â†’ 0.3~1.1
          );
          
          // æ—¢å­˜ã®ãƒªãƒ³ã‚°ã¨ã®è·é›¢ã‚’ãƒã‚§ãƒƒã‚¯
          validPosition = true;
          for (const existingPos of positions) {
            if (newPos.distanceTo(existingPos) < minDistance) {
              validPosition = false;
              break;
            }
          }
          attempts++;
        }
        
        if (validPosition) {
          positions.push(newPos);
        }
      }
      
      // ãƒªãƒ³ã‚°ã‚’ç”Ÿæˆï¼ˆ3å€‹ç›®ã‚’ãƒœãƒ¼ãƒŠã‚¹ã«ï¼‰
      positions.forEach((pos, i) => {
        const isBonus = i === 2; // 4 â†’ 2ï¼ˆ6å€‹ä¸­3å€‹ç›®ï¼‰
        rings.push(createRing(pos, isBonus));
      });
      
      console.log('ğŸ¯ ãƒªãƒ³ã‚°ç”Ÿæˆå®Œäº†ï¼ˆ30ç§’ãƒ¢ãƒ¼ãƒ‰ï¼‰:', rings.length);
    }
    
    function clearRings() {
      rings.forEach(ring => {
        if (ring.element && ring.element.parentNode) {
          worldRoot.removeChild(ring.element);
        }
      });
      rings = [];
    }
    
    // ========== ãƒ‰ãƒ­ãƒ¼ãƒ³ç”Ÿæˆ ==========
    function spawnDrone() {
      if (drone && drone.parentNode) {
        worldRoot.removeChild(drone);
        console.log('ğŸ”„ æ—¢å­˜ãƒ‰ãƒ­ãƒ¼ãƒ³ã‚’å‰Šé™¤ã—ã¦å†ç”Ÿæˆ');
      }
      
      drone = document.createElement('a-entity');
      drone.setAttribute('gltf-model', 'drone.glb');
      drone.setAttribute('scale', '2 2 2');
      worldRoot.appendChild(drone);
      
      drone.addEventListener('model-loaded', () => {
        const root = drone.getObject3D('mesh') || drone.object3D;
        if (root) collectRotors(root);
      });
      
      const camObj = camEl.object3D;
      const camPos = new THREE.Vector3();
      const forward = new THREE.Vector3();
      camObj.getWorldPosition(camPos);
      camObj.getWorldDirection(forward);
      
      pos.copy(camPos)
        .add(forward.multiplyScalar(CONFIG.spawnDistance))
        .add(new THREE.Vector3(0, CONFIG.spawnLift, 0));
      
      const camQuat = camObj.getWorldQuaternion(new THREE.Quaternion());
      const camEuler = new THREE.Euler().setFromQuaternion(camQuat, 'YXZ');
      yawEuler.set(0, camEuler.y + Math.PI, 0);
      
      currentTilt = { pitch: 0, roll: 0 };
      drone.object3D.position.copy(pos);
      drone.object3D.rotation.set(currentTilt.pitch, yawEuler.y, currentTilt.roll);
      
      takeoffAnim.active = true;
      takeoffAnim.start = performance.now();
      currentRPM = CONFIG.rpmIdle * 0.2;
      
      console.log('ğŸš ãƒ‰ãƒ­ãƒ¼ãƒ³ç”Ÿæˆå®Œäº†');
    }
    
    marker.addEventListener('markerFound', () => {
      console.log('ğŸ“ ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡º');
      spawnDrone();
    });
    
    // ========== ã‚²ãƒ¼ãƒ åˆ¶å¾¡ ==========
    function startGame() {
      if (!drone) {
        alert('ãƒãƒ¼ã‚«ãƒ¼ã‚’å†™ã—ã¦ãƒ‰ãƒ­ãƒ¼ãƒ³ã‚’å‡ºç¾ã•ã›ã¦ãã ã•ã„');
        return;
      }
      
      gameState.active = true;
      gameState.score = 0;
      gameState.startTime = performance.now();
      gameState.ringsCleared = 0;
      gameState.combo = 0;
      gameState.gameOver = false;
      
      spawnRings();
      updateUI();
      
      document.getElementById('start-btn').disabled = true;
      console.log('ğŸ® ã‚²ãƒ¼ãƒ é–‹å§‹ï¼ï¼ˆ30ç§’ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼‰');
    }
    
    function resetGame() {
      gameState.active = false;
      gameState.score = 0;
      gameState.elapsedTime = 0;
      gameState.ringsCleared = 0;
      gameState.combo = 0;
      gameState.gameOver = false;
      
      clearRings();
      updateUI();
      
      document.getElementById('start-btn').disabled = false;
      document.getElementById('complete-message').style.display = 'none';
      console.log('ğŸ”„ ã‚²ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ');
    }
    
    function gameOverTime() {
      gameState.active = false;
      gameState.gameOver = true;
      
      document.getElementById('final-time').textContent = 
        `â±ï¸ ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—ï¼\nã‚¹ã‚³ã‚¢: ${gameState.score}ç‚¹\nã‚¯ãƒªã‚¢: ${gameState.ringsCleared}/${gameState.totalRings}å€‹`;
      document.getElementById('complete-message').style.display = 'block';
      document.getElementById('complete-message').style.background = 'rgba(255, 100, 0, 0.95)';
      document.getElementById('start-btn').disabled = false;
      
      console.log('â±ï¸ ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—ï¼');
    }
    
    function completeGame() {
      gameState.active = false;
      const finalTime = gameState.elapsedTime;
      
      if (!gameState.bestTime || finalTime < gameState.bestTime) {
        gameState.bestTime = finalTime;
        localStorage.setItem('bestTime', finalTime);
      }
      
      document.getElementById('final-time').textContent = 
        `ã‚¿ã‚¤ãƒ : ${finalTime.toFixed(2)}ç§’\nãƒ™ã‚¹ãƒˆ: ${gameState.bestTime.toFixed(2)}ç§’\nã‚¹ã‚³ã‚¢: ${gameState.score}ç‚¹`;
      document.getElementById('complete-message').style.display = 'block';
      document.getElementById('complete-message').style.background = 'rgba(0, 200, 0, 0.95)';
      document.getElementById('start-btn').disabled = false;
      
      console.log('ğŸ‰ ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ï¼');
    }
    
    function updateUI() {
      document.getElementById('score-display').textContent = gameState.score;
      
      const remainingTime = Math.max(0, gameState.timeLimit - gameState.elapsedTime);
      const timeColor = remainingTime < 10 ? '#FF3B30' : '#fff';
      const timerEl = document.getElementById('timer-display');
      timerEl.textContent = gameState.active ? `${remainingTime.toFixed(1)}s` : '30.0s';
      timerEl.style.color = timeColor;
      
      document.getElementById('rings-left').textContent = 
        `æ®‹ã‚Š: ${gameState.totalRings - gameState.ringsCleared}å€‹`;
    }
    
    function showCombo(points) {
      const comboEl = document.getElementById('combo-display');
      comboEl.textContent = `+${points}`;
      comboEl.style.opacity = '1';
      
      setTimeout(() => {
        comboEl.style.opacity = '0';
      }, 800);
    }
    
    function checkRingCollision() {
      if (!drone || !gameState.active) return;
      
      const dronePos = drone.object3D.position;
      const now = performance.now();
      
      rings.forEach(ring => {
        if (ring.cleared) return;
        
        const distance = dronePos.distanceTo(ring.position);
        
        if (distance < CONFIG.ringCheckDistance) {
          ring.cleared = true;
          ring.element.setAttribute('animation', 'property: scale; to: 0 0 0; dur: 300; easing: easeInQuad');
          
          setTimeout(() => {
            if (ring.element.parentNode) {
              worldRoot.removeChild(ring.element);
            }
          }, 300);
          
          const points = ring.isBonus ? 300 : 100;
          
          if (now - gameState.lastClearTime < CONFIG.comboTimeWindow) {
            gameState.combo++;
          } else {
            gameState.combo = 1;
          }
          
          const totalPoints = points * gameState.combo;
          gameState.score += totalPoints;
          gameState.ringsCleared++;
          gameState.lastClearTime = now;
          
          showCombo(totalPoints);
          updateUI();
          
          console.log(`ğŸ¯ ãƒªãƒ³ã‚°ã‚¯ãƒªã‚¢ï¼ +${totalPoints} (ã‚³ãƒ³ãƒœ: x${gameState.combo})`);
          
          if (gameState.ringsCleared >= gameState.totalRings) {
            completeGame();
          }
        }
      });
    }
    
    // ========== ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ ==========
    document.getElementById('start-btn').addEventListener('click', startGame);
    document.getElementById('reset-btn').addEventListener('click', resetGame);
    
    // ========== ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ ==========
    const input = { left: { x: 0, y: 0 }, right: { x: 0, y: 0 } };
    
    const stopTouch = (e) => {
      e.preventDefault();
      e.stopPropagation();
      return false;
    };
    
    document.addEventListener('touchstart', stopTouch, { passive: false });
    document.addEventListener('touchmove', stopTouch, { passive: false });
    
    const left = nipplejs.create({
      zone: document.getElementById('leftStick'),
      mode: 'static',
      position: { left: '75px', bottom: '75px' },
      color: 'white'
    });
    
    left.on('move', (_, data) => {
      input.left.x = data.vector.x;
      input.left.y = data.vector.y;
    });
    
    left.on('end', () => {
      input.left.x = 0;
      input.left.y = 0;
    });
    
    const right = nipplejs.create({
      zone: document.getElementById('rightStick'),
      mode: 'static',
      position: { right: '75px', bottom: '75px' },
      color: 'white'
    });
    
    right.on('move', (_, data) => {
      input.right.x = data.vector.x;
      input.right.y = data.vector.y;
    });
    
    right.on('end', () => {
      input.right.x = 0;
      input.right.y = 0;
    });
    
    // ========== ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ— ==========
    function tick() {
      requestAnimationFrame(tick);
      
      if (!drone) return;
      
      let takeoffOffset = 0;
      if (takeoffAnim.active) {
        const elapsed = performance.now() - takeoffAnim.start;
        const t = Math.min(1, elapsed / CONFIG.takeoffDuration);
        takeoffOffset = CONFIG.takeoffHeight * (1 - Math.pow(1 - t, 3));
        
        if (t >= 1) {
          takeoffAnim.active = false;
        }
        
        currentRPM += (CONFIG.rpmIdle - currentRPM) * 0.05;
      } else {
        const inputMagnitude = Math.sqrt(
          input.left.y ** 2 + 
          input.right.x ** 2 + 
          input.right.y ** 2
        );
        
        const targetRPM = inputMagnitude > 0.1 
          ? CONFIG.rpmHover + (CONFIG.rpmMax - CONFIG.rpmHover) * Math.min(inputMagnitude, 1)
          : CONFIG.rpmHover;
        
        currentRPM += (targetRPM - currentRPM) * CONFIG.rpmAccel;
      }
      
      pos.y += input.left.y * CONFIG.speedVertical;
      yawEuler.y += THREE.MathUtils.degToRad(-input.left.x * CONFIG.speedYaw);
      
      const yawCos = Math.cos(yawEuler.y);
      const yawSin = Math.sin(yawEuler.y);
      
      const fwd = input.right.y * CONFIG.speedForward;
      const strafe = input.right.x * CONFIG.speedStrafe;
      
      pos.x += fwd * yawSin + strafe * yawCos;
      pos.z += fwd * yawCos - strafe * yawSin;
      
      pos.x = THREE.MathUtils.clamp(pos.x, -CONFIG.boundaryX, CONFIG.boundaryX);
      pos.y = THREE.MathUtils.clamp(pos.y, CONFIG.boundaryY.min, CONFIG.boundaryY.max);
      pos.z = THREE.MathUtils.clamp(pos.z, -CONFIG.boundaryZ, CONFIG.boundaryZ);
      
      const targetPitch = THREE.MathUtils.degToRad(CONFIG.tiltMax * input.right.y);
      const targetRoll = THREE.MathUtils.degToRad(-CONFIG.tiltMax * input.right.x);
      
      currentTilt.pitch = THREE.MathUtils.lerp(currentTilt.pitch, targetPitch, CONFIG.tiltSmooth);
      currentTilt.roll = THREE.MathUtils.lerp(currentTilt.roll, targetRoll, CONFIG.tiltSmooth);
      
      drone.object3D.position.set(pos.x, pos.y + takeoffOffset, pos.z);
      drone.object3D.rotation.set(currentTilt.pitch, yawEuler.y, currentTilt.roll);
      
      if (rotors.length > 0) {
        const dAngle = rpmToRadPerSec(currentRPM) * 0.016;
        for (const rotor of rotors) {
          rotor.obj.rotateOnAxis(rotor.axis, dAngle);
        }
      }
      
      if (gameState.active) {
        gameState.elapsedTime = (performance.now() - gameState.startTime) / 1000;
        
        // ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—ãƒã‚§ãƒƒã‚¯
        if (gameState.elapsedTime >= gameState.timeLimit && !gameState.gameOver) {
          gameOverTime();
        }
        
        updateUI();
        checkRingCollision();
      }
    }
    
    requestAnimationFrame(tick);
    
    // ========== ã‚¢ãƒ—ãƒªå†…ãƒ–ãƒ©ã‚¦ã‚¶æ¤œå‡º ==========
    function detectInAppBrowser() {
      const ua = navigator.userAgent.toLowerCase();
      const isLine = ua.includes('line');
      const isInstagram = ua.includes('instagram');
      const isFacebook = ua.includes('fb') || ua.includes('facebook');
      const isTwitter = ua.includes('twitter');
      const isWeChat = ua.includes('micromessenger');
      
      if (isLine || isInstagram || isFacebook || isTwitter || isWeChat) {
        document.getElementById('browser-warning').style.display = 'block';
        console.warn('âš ï¸ ã‚¢ãƒ—ãƒªå†…ãƒ–ãƒ©ã‚¦ã‚¶ã‚’æ¤œå‡º');
        return true;
      }
      return false;
    }
    
    window.addEventListener('load', () => {
      detectInAppBrowser();
    });
    
    console.log('ğŸš AR Drone Ring Challenge èµ·å‹•å®Œäº†ï¼');
    } // initAR()ã®çµ‚äº†
  </script>
</body>
</html>
